name: ELO Benchmark between PR and master
on:
  pull_request:
    branches: [master]
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  build-both-and-benchmark:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout PR (current)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          path: pr

      - name: Fetch master (shallow)
        working-directory: pr
        run: |
          git fetch origin master --depth=1

      - name: Prepare worktree for master
        working-directory: pr
        run: |
          # Worktree fÃ¼r master neben das PR-Repo legen
          git worktree add -f ../master origin/master
          git worktree list

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache cargo (PR)
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            pr/target
          key: cargo-${{ runner.os }}-pr-${{ hashFiles('pr/Cargo.lock') }}
          restore-keys: |
            cargo-${{ runner.os }}-pr-

      - name: Build PR (current) and place binary in ./testing/current
        working-directory: pr
        run: |
          cargo build --locked --release
          mkdir -p testing
          cp target/release/thunfisch testing/current
          chmod +x testing/current

      - name: Cache cargo (master)
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            master/target
          key: cargo-${{ runner.os }}-master-${{ hashFiles('master/Cargo.lock') }}
          restore-keys: |
            cargo-${{ runner.os }}-master-

      - name: Build master (previous) and place binary in ./testing/previous (inside PR repo)
        working-directory: master
        run: |
          cargo build --locked --release
          mkdir -p ../pr/testing
          cp target/release/thunfisch ../pr/testing/previous
          chmod +x ../pr/testing/previous

      - name: Install fastchess
        run: |
          cd /tmp
          wget https://github.com/Disservin/fastchess/releases/download/v1.6.0-alpha/fastchess-linux-x86-64.tar
          tar -xf fastchess-linux-x86-64.tar
          # Add the directory containing the executable to the system PATH
          echo "/tmp/fastchess-linux-x86-64" >> $GITHUB_PATH

      - name: Run benchmark script from PR repo
        working-directory: pr
        run: |
          # Verify the installation
          fastchess --version
          # Run the benchmark
          fastchess \
          -engine cmd=./testing/current \
          name=current \
          -engine cmd=./testing/previous \
          name=previous \
          -each proto=uci \
          -each tc=0/0:15+1 \
          -rounds 10 \
          -concurrency 4 \
          -openings file=./testing/8moves_v3.pgn format=pgn order=random \
          > benchmark_summary.txt 2>&1

      - name: Extract benchmark summary
        if: github.event_name == 'pull_request'
        working-directory: pr
        run: tail -n 10 benchmark_summary.txt > benchmark_for_comment.txt

      - name: Post Benchmark Results to PR
        if: github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v3
        with:
          file-path: pr/benchmark_for_comment.txt